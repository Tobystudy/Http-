# 17장 내용헙상과 트랜스 코딩

## 내용협상
> 자원(Resource)는 URI로 구별되는 개념적인 존재다.(RFC 2396)
>
> - 웹 서버는 자원의 표현(Representations)을 제공한다. 표현은 지정된 media type, 문자집합, 인코딩 등을 가진 바이트들로 되있다.
> - 자원은 여러 방식으로 표현될 수 있으며, 이때 자원은 협상가능해진다.
> - 자원의 각 표현은 변형(variant)라고 칭한다. 협상 가능한 자원의 변형 종류를 협상의 범위라고 한다.
>
> [by 아파치 내용 협상](https://httpd.apache.org/docs/trunk/ko/content-negotiation.html)


### 클라이언트 주도
- 클라이언트가 요청을 보내면 서버가 선택지를 보내주고 클라이언트가 선택하기
- eg) 모바일 버전 / PC 버전 을 선택하는 방식

- 구현 난이도가 쉽고, 클라이언트 입장에서도 최선을 선택하기가 쉽다.
- 대기시간이 증가하고, 올바른 컨텐츠를 얻기위해 컨텐츠 선택을 하는 과정이 필요하다


### 서버주도
- 서버가 클라이언트의 요청 헤더를 검증하여 어떤 버전을 제공할지 결정
- 협상 스텝이 하나 줄기 때문에 좀더 빠르다
- q값과 Vary 헤더 표준 스펙으로 협상
- 만약 결정이 뻔하지 않으면 서버는 추측해야함 
  - e.g) fr=1.0 en=0 인데 서버는 en, kr만 제공하는경우 어떻게해야할까? 서버 구현에따라 다름

#### 내용협상 헤더
- Accept : 서버가 어떤 미디어 타입으로 보내도 되는지 알려준다.
- Accept-Langauage : 어떤 언어로 보내도 되는지 알려준다
- Accept-Charset : 어떤 차셋으로 보내도 되는지 알려준다.
- Accept-Encoding : 어떤 인코딩으로 보내도 되는지 알려준다.

  => 엔터티 헤더와 매칭되어 응답을 해주면 됨

#### 내용 협상 헤더의 품질값

 > Accept-Language : en;q=0.5, fr;q=0.0, nl;q=1.0, trlq=0.0

위처럼 어떤 컨텐츠를 더 선호하는지 가중치를 줄 수 있음


#### 서버의 협상 구현 방법 - 아파치
> 대표적인 웹서버인 아파치의 협상 구현 방법 정리

> 변형을 담은 파일들을 직접 열거한 type map을 사용

- 웹사이트 콘텐츠의 제공자가 리소스의 여러 표현방법들을 각각 적절한 디렉토리에 넣어준다.

이후 아래 두가지 방법중 하나를 사용한다

(1) 웹사이트 디렉터리에서 variant를 갖는 웹 사이트의 각 URI를 위한 type-map 파일을 만든다.
  - 이떄 type-map 파일은 모든 배리언트와 그들 각각에 대응하는 내용 협상 헤더들을 나열한다.
(2) 아파치가 그 디렉터리에 대해 자동으로 type-map 파일을 생성하도록하는 MultiView 지시어를 킨다



### 투명협상(중개자 협상)
- 웹서버의 부담이 덜하고, 클라이언트 주도에 비해서는 여전히 스텝이 하나 없어 빠르다
- 표준 명세가 없음


- 사실상 캐시 레이어로서 모든 협상에 대한 버전을 캐싱하고, 서버에서 수행하는 협상 로직을 프록시가 그대로 들고 있어서 클라이언트와 서버입장에서 협상하고 응답하는 방식

#### Vary 헤더
- 서버의 응답이 어떤 근거로 협상되었는지 표현하는 헤더

    Vary: User-Agent, Cookie


## 트랜스 코딩
> 서버가 내용 협상에 따른 컨텐츠 표현이 없을때, 직접 해당 표현을 만들어 제공하는 동작

eg) 고해상도 이미지 -> 저해상도 이미지, 광고가 있는 페이지 -> 광고가 없는 페이지 등등

트랜스 코딩은 아래와 같이 크게 3종류가 있다

- 포멧 변환
- 정보 합성
- 콘텐츠 주입

### 트랜스 코딩 vs 정적으로 준비
- 트랜스 코딩에 의한 응답시간 증가
- 복잡도 증가
- 하지만 모든걸 정적으로 준비하는것도 쉬운일이 아님
- 트랜스 코딩을 한다면 트랜스 코딩 레이어 vs 각 서버

#### eg) Transcoding grpc to http / http to grpc

- 각 서버가 http와 grpc 양 프로토콜을 모두 지원할수도 있지만, 게이트웨이 단에서 트랜스 코딩을 통해 프로토콜을 변환할수도 있다
- https://bluepinme.medium.com/http-grpc-with-spring-web-fd9af6a56935
  
 

