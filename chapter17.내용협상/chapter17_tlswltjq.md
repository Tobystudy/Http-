# 내용 협상과 트랜스코딩
하나의 URL가 여러 리소스에 대응할 필요가 있는 경우들이 있다.<br>
다국어를 지원하는 페이지, 사용자 맞춤형 페이지(광고)와 같은 리소스등

서버는 클라이언트에게 어떤 베리언트(variant : 리소스의 서로 다른 버전)를 주어야할지 판단할 수 있어야한다.<br>
어떤 경우엔 커스터마이징된 페이지를 자동으로 생성해 제공한다.

이 장에서 내용 협상이란 무엇이고 웹 애플리케이션이 어떻게 협상을 수행하는지 알아본다.

## 내용 협상 기법
서버에 있는 페이지중 어떤것이 클라이언트에게 맞는지 판단하는 방법은 세 가지가 있다.
|기법|어떻게 동작하는가|장점|단점|
|-|-|-|-|
|클라이언트 주도|클라이언트가 요청을 보내면 서버가 클라이언트에게 선택지를 보여주고 클라이언트가 선택한다.|서버 입장에서 구현하기 쉽고 클라이언트는 최선의 선택이 가능하다|올바른 컨텐츠를 얻기위해 최소 두 번의 요청이 필요하기에 대기시간이 증가한다.|
|서버 주도|서버가 클라이언트의 요청헤더를 검증해 어떤 버전을 제공할지 결정한다|클라이언트 주도 협상법보다 빠르다. HTTP는 서버가 가장 적절한 것을 선택할 수 있도록 q값 메커니즘을 제공하고, 서버가 다운 스트림 장치에게 요청이 어떻게 평가되는지 말하기 위해 Vary헤더를 제공한다.|만약 결정이 뻔하지 않으면(헤더에 맞는 것이 없으면), 서버는 추측을 해야만한다.|
|투명|투명한 중간장치(프락시 캐시)가 서버를 대신해 협상한다|서버가 협상할 필요가 없고 클라이언트 주도 협상보다 빠르다.|협상을 어떻게 하는지 정형화된 명세가 없다|

## 클라이언트 주도 협상
300 Multiple Choices응답을 돌려주거나. 여러 버전의 링크가 담긴 페이지를 돌려주거나 브라우저 사용자에의해 수동적으로 선택될것이다.<br>
이는 매우 느리다.

또한 베리언트마다 개별의 URL을 요구하는 문제가 있다.
## 서버 주도 협상
클라이언트 주도 협상은 최적의 페이지를 결정하기위해 여러번의 커뮤니케이션이 필요하다.<br>
이런 커뮤니케이션을 줄이기 위해, 클라이언트는 서버에게 선호도에대한 충분한 정보를 제공하여 서버가 현명한 결정을 할 수 있도록 해야한다.

서버는 클라이언트의 선호도를 요청 헤더로부터 얻는다.<br>
서버가 현명한 결정을 하기 위한 메커니즘은 크게 두 가지이다.
- 내용 협상 헤더를 살펴보고 그에대한 응답 헤더를 준비한다.
- 내용 협상 헤더 외의 다른 헤더를 살펴본다. ex) User-Agent 헤더에 기반한 응답을 할 수 있다.
### 내용 협상 헤더
서버는 클라이언트측의 Accept관련 헤더를 Content헤더와 적절히 짝지어 가장 적절한 문서를 제공할 수 있게 해 준다.
|Accept 관련 헤더|엔터티 헤더|
|-|-|
|Accept|Content-Type|
|Accept-Language|Content-Language|
|Accept-Charset|Content-Type|
|Accept-Encoding|Content-Encoding|
HTTP 상태가 없는 프로토콜이기 때문이기 때문에 자신의 선호정보 매번 보내, 서버가 가장 적합만 문서를 고를 수 있도록 해야한다.
### 내용 협상 헤더의 품질값
하나의 문서에 대해 여러 항목의 선호 정보를 선호도, 품질값(q) 와 함께 나열 할 수 있다.
```http
Accept-Language: en;q=0.5, fr;q=0.0, nl;q=1.0, tr;q=0.0
```
Accept헤더가 아니더라도 서버는 User-Agent와 같은 헤더또한 응답을 생성해내기 위해서 사용된다.
### 아파치의 내용 협상
아파치가 내용 협상을 지원하는 방법은 두 가지 이다.
- 웹 사이트의 디렉터리에서 배리언트를 갖는 웹사이트의 각 URI를 위한 type-map파일을 만든다
- 아파치가 그 디렉토리에 대해서 자동으로 type-map파일을 생성하도록 지시하는 MultiViews 지시어를 킨다.
## 투명 협상
클라이언트 입장에서 중개자 프락시를 둠으로 서버와 클라이언트의 직접적인 메시지교환은 최소화 되면서 서버 주도 협상으로 인한 부하를 서버가 덜 수 있다.
### 캐시와 얼터네이트
얼터네이트란 클라이언트에게 제공될 수 있는 리소스의 대안 배리언트는 해당 리소스의 여러 버전
유사한듯 하지만 조금 다른 범위를 가짐
### vary헤더
Vary 헤더는 HTTP 응답 헤더로, 요청 메시지의 메서드와 URL을 제외하고 응답 내용에 영향을 준 부분을 나타낸다.
<br>주로 콘텐츠 협상이 사용될 때 캐시 키를 생성하는 데 사용된다.

vary헤더의 주요 용도는 다음과 같다
- 캐시 효율성 향상: Vary 헤더를 사용하면 서버는 요청 헤더에 따라 다양한 응답을 캐시 할 수 있다.
- 개인화된 응답 제공: 사용자의 설정이나 기기에 따라 맞춤화된 응답을 제공할 수 있다.
## 트랜스코딩
요구사항에 맞춘 제공할 수 있는 문서가 없다면? 에러로 답해야하겠지만 기존의 문서와 여러 정보를 합쳐 새로운 무언가를 만들 수 있다.

트랜스코딩에는 포맷 변환, 정보 합성, 내용 주입의 세 종류가 있다.
### 포맷 변환
데이터를 클라이언트가 볼 수 있도록 포맷을 변경하는것

전송인코딩과는 다르다.
### 정보 합성
문서에서 정보의 요점을 추출 하는것을 정보 합성이라고 한다.

### 콘텐츠 주입
앞의 두 종류는 일반적으로 문서의 양을 줄이지만 콘텐츠주입은 반대로 늘릴 수 있다.
자동 생성되어 삽입되는 광고 등이 있다.
