# 캐시
웹 캐시는 문서의 사본을 자동으로 등록하는 HTTP장치
웹 요청은 캐시에 도착하면 캐시된 로컬 사본의 유무를 파악하여 로컬 사본이 존재한다면 원 서버가 아닌 캐시로부터 제공받는다.
#### 캐시의 혜택
- 캐시는 불필요한 데이터 전송을 줄인다, 이는 네트워크 요금의 감소로 이어진다.
- 캐시는 네트워크 병목을 줄여준다. 대역폭을 늘리지 않고도 페이지를 빠르게 불러올 수 있다.
- 캐시는 원 서버에 대한 요청을 줄여준다. 서버는 줄어든 부하만큼 더 빠른 응답을 할 수 있다.
- 캐시는 거리에 따른 지연을 줄여준다.
#### 이 장에서 우리는
- 캐시의 성능을 개선하고 비용을 줄이는 방법
- 그 효과를 측정하는법
- 효과를 극대화하기위한 캐시의 위치
- HTTP가 캐시된 사본을 신선하게 유지하는법
- 캐시가 캐시나 서버와 상호작용하는 방법
## 7.1 불필요한 데이터 전송
하나의 리소스를 여러곳에서 접근해 온다면?
네트워크를 통해 동일한 코드들이 반복해서 이동한다.
이는 불필요한 비용과 부하
>요청에 사본을 만들어 두어 같은 요청은 사본을 주자
## 7.2 대역폭 병목
대역폭은 문서의 크기에 따라 큰 차이가 남.
클라이언트들이 서버에 접근할때의 속도 == 경로상 가장 느린 네트워크의 속도

가까운 네트워크의 캐시로부터 사본을 가져온다면? 성능 향상 가능.
## 7.3 요청쇄도
짧은 시간에 많은 트래픽 증가는 웹서버의 장애로 이어진다.
## 7.4 거리로 인한 지연
모든 네트워크 라우터는 네트워크 지연을 유발
또한 빛의 속도가 유의미한 지연을 유발
(빛이 왜? 광랜 케이블로 이루어져있나?) [ㅇㅇ](https://www.submarinecablemap.com/)
## 7.5 적중과 부적중
캐시 히트 = 캐시에 찾는 사본이 있음
캐시 미스 = 캐시에 사본없음 캐시가 원 서버로 다시 요청을해야함
### 재검사
캐시에 존재하는 사본의 신선도를 검사하는것
요청으로인한 비교일 수도 있고 자체적으로 재 검사한 것 일수도 있음

재검사 후 제공됨을 느린적중(revalidate hit / slow hit) 이라고 함
느린적중은 당연하게도 부적중보단 빠르고 적중보단 느림
### 적중률
캐시가 요청을 처리하는 비율
### 바이트 적중률
요청이 아닌 바이트 단위로 적중률을 계산하는것
### 적중과 부적중의 구별
클라이언트는 원서버에서 온 것인지 캐시에서 온 것인지 상태코드만으로는 알 수 없음.
어느 상용 프락시는 via헤더에 추가정보를 제공하기도 함.
Date헤더의 응답 헤더값과 응답시점의 시간을 비교해 응답이 더 오래됬다면 캐시된 것임을 알 수 있다.
## 7.6 캐시 토폴로지
공용 캐시는 공통의 관심사를 캐시해 트래픽을 줄일 수 있다.
### 계층화된 캐시 레이어
작은 캐시에서 사용자의 요청을 최대한 처리하고 실패할 때 마다 1단계씩 더 큰 캐시에 요청하기.

#### 캐시 망, 콘텐츠 라우팅, 피어링
캐시망의 프락시 캐시는 복잡한 방식으로 대화해 어떤 부모와 대화할것인지 원 서버로 가도록할 것인지 동적으로 결정한다.
?AWS의 Route53이 이렇게 구성된걸까.
## 7.7 캐시 처리 단계
1. 요청 받기 : 캐시가 네트워크로 부터 도착한 요청 메시지를 읽난다.
2. 파싱 : 캐시가 메시지를 파싱해 URL과 헤더를 추출
3. 검색 : 캐시는 로컬에서 사본이 있는지 검사하고, 사본이 없으면 원 서버로부터 사본을 받아와 로컬에 저장한다.
4. 신선도 검사 : 캐시가 사본을 검사하고 신선한지 확인한다. 신선하지 않다면  서버에 물어본다.
5. 응답 생성 : 캐시가 새로운 헤더와 캐시된 본문으로 응답 메시지를 만든다.
6. 발송 : 네트워크를 통해 응답을 클라이언트에게 돌려준다.
7. 로깅 : 선택적으로 로그파일에 트랜잭션을 서술한 로그를 남긴다.
## 7.8 선도 유지
### 문서만료
Cache-Control과 Expires 헤더를 이용해 원 서버가 각 문서에서 유효기간을 붙인다.
### 서버 재검사
문서만료 = 사본이 원서버 문서랑 내용이 다름

=>

재검사실시(서버 재검사)

문서 만료기간을 정하고 만료 되었을때만 신선도 검사를 한다(요청에 재검사가 없다면)
## 7.9 캐시 제어
#### Cache-Control: no-store
캐시가 응답의 사본을 만드는것을 금지
#### Cache-Control: no-cache
로컬에 저장 될 수 있지만 재검사 하지않고서는 제공될 수 없다.
#### Cache-Control: must-revalidate
엄격하게 신선한 객체만을 제공하기위해 반드시 재검사하도록 한다.
#### Cache-Control: max-age
캐시가 유효한 최대 시간